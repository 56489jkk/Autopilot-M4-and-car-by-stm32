/*
 * Copyright (c) 2006-2021, RT-Thread Development Team
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Change Logs:
 * Date           Author       Notes
 * 2022-04-06     CGY       the first version
 */
#include "DL_OpticalFlow_LC306.h"

opt_data LC306_opt_receive(uint8_t data)
{
    static opt_data T1_opt={0};
    static int16_t raw_data[2],dest_data[2];
    static uint8_t data_len = 0;
    static uint8_t state = 0;

    if(state==0&&data==0xFE)    //
    {
        state=1;
    }
    else if(state==1&&data==0x0A)   //
    {
        state=2;
        data_len = 12;
        T1_opt.dataLen = 0;
    }
    else if(state==2&&data_len>0)
    {
        data_len--;
        T1_opt.data[T1_opt.dataLen++]=data;
        if(data_len==0 && T1_opt.data[11]==0x55){
            state=0;
            T1_opt.sonar_timestamp = T1_opt.data[5]<<8|T1_opt.data[4];    //  20800us
            T1_opt.distance =  (T1_opt.data[7]<<8|T1_opt.data[6])/10;     //cm
            T1_opt.qual = T1_opt.data[8];
            if (T1_opt.qual==0xF5) {
                raw_data[0] =  ((int16_t)(T1_opt.data[1]<<8)|T1_opt.data[0]);   //向前
                raw_data[1] =  ((int16_t)(T1_opt.data[3]<<8)|T1_opt.data[2]);   //向右
                //调整传感器坐标系 使传感器坐标和飞控坐标对齐
                applySensorAlignment_2(dest_data,raw_data,Flow_Sensor_Rotation);
                T1_opt.raw_x = dest_data[0];   //向前
                T1_opt.raw_y = dest_data[1];   //向右
                T1_opt.last_update_ms = rt_tick_get();
            } else {
                T1_opt.raw_x = 0;   //
                T1_opt.raw_y = 0;
            }
        }
    }
    else
    {
        state=0;
    }

    return T1_opt;
}



/**********************************************LC306光流配置***************************************************/
#if 1
uint8_t SENSOR_IIC_ADDR=0xdc;
uint8_t tab_focus[4] = {0x96,0x26,0xbc,0x50};
uint8_t Sensor_cfg[]={
  0x12, 0x80,
  0x11, 0x30,
  0x1b, 0x06,
  0x6b, 0x43,
  0x12, 0x20,
  0x3a, 0x00,
  0x15, 0x02,
  0x62, 0x81,
  0x08, 0xa0,
  0x06, 0x68,
  0x2b, 0x20,
  0x92, 0x25,
  0x27, 0x97,
  0x17, 0x01,
  0x18, 0x79,
  0x19, 0x00,
  0x1a, 0xa0,
  0x03, 0x00,
  0x13, 0x00,
  0x01, 0x13,
  0x02, 0x20,
  0x87, 0x16,
  0x8c, 0x01,
  0x8d, 0xcc,
  0x13, 0x07,
  0x33, 0x10,
  0x34, 0x1d,
  0x35, 0x46,
  0x36, 0x40,
  0x37, 0xa4,
  0x38, 0x7c,
  0x65, 0x46,
  0x66, 0x46,
  0x6e, 0x20,
  0x9b, 0xa4,
  0x9c, 0x7c,
  0xbc, 0x0c,
  0xbd, 0xa4,
  0xbe, 0x7c,
  0x20, 0x09,
  0x09, 0x03,
  0x72, 0x2f,
  0x73, 0x2f,
  0x74, 0xa7,
  0x75, 0x12,
  0x79, 0x8d,
  0x7a, 0x00,
  0x7e, 0xfa,
  0x70, 0x0f,
  0x7c, 0x84,
  0x7d, 0xba,
  0x5b, 0xc2,
  0x76, 0x90,
  0x7b, 0x55,
  0x71, 0x46,
  0x77, 0xdd,
  0x13, 0x0f,
  0x8a, 0x10,
  0x8b, 0x20,
  0x8e, 0x21,
  0x8f, 0x40,
  0x94, 0x41,
  0x95, 0x7e,
  0x96, 0x7f,
  0x97, 0xf3,
  0x13, 0x07,
  0x24, 0x58,
  0x97, 0x48,
  0x25, 0x08,
  0x94, 0xb5,
  0x95, 0xc0,
  0x80, 0xf4,
  0x81, 0xe0,
  0x82, 0x1b,
  0x83, 0x37,
  0x84, 0x39,
  0x85, 0x58,
  0x86, 0xff,
  0x89, 0x15,
  0x8a, 0xb8,
  0x8b, 0x99,
  0x39, 0x98,
  0x3f, 0x98,
  0x90, 0xa0,
  0x91, 0xe0,
  0x40, 0x20,
  0x41, 0x28,
  0x42, 0x26,
  0x43, 0x25,
  0x44, 0x1f,
  0x45, 0x1a,
  0x46, 0x16,
  0x47, 0x12,
  0x48, 0x0f,
  0x49, 0x0d,
  0x4b, 0x0b,
  0x4c, 0x0a,
  0x4e, 0x08,
  0x4f, 0x06,
  0x50, 0x06,
  0x5a, 0x56,
  0x51, 0x1b,
  0x52, 0x04,
  0x53, 0x4a,
  0x54, 0x26,
  0x57, 0x75,
  0x58, 0x2b,
  0x5a, 0xd6,
  0x51, 0x28,
  0x52, 0x1e,
  0x53, 0x9e,
  0x54, 0x70,
  0x57, 0x50,
  0x58, 0x07,
  0x5c, 0x28,
  0xb0, 0xe0,
  0xb1, 0xc0,
  0xb2, 0xb0,
  0xb3, 0x4f,
  0xb4, 0x63,
  0xb4, 0xe3,
  0xb1, 0xf0,
  0xb2, 0xa0,
  0x55, 0x00,
  0x56, 0x40,
  0x96, 0x50,
  0x9a, 0x30,
  0x6a, 0x81,
  0x23, 0x33,
  0xa0, 0xd0,
  0xa1, 0x31,
  0xa6, 0x04,
  0xa2, 0x0f,
  0xa3, 0x2b,
  0xa4, 0x0f,
  0xa5, 0x2b,
  0xa7, 0x9a,
  0xa8, 0x1c,
  0xa9, 0x11,
  0xaa, 0x16,
  0xab, 0x16,
  0xac, 0x3c,
  0xad, 0xf0,
  0xae, 0x57,
  0xc6, 0xaa,
  0xd2, 0x78,
  0xd0, 0xb4,
  0xd1, 0x00,
  0xc8, 0x10,
  0xc9, 0x12,
  0xd3, 0x09,
  0xd4, 0x2a,
  0xee, 0x4c,
  0x7e, 0xfa,
  0x74, 0xa7,
  0x78, 0x4e,
  0x60, 0xe7,
  0x61, 0xc8,
  0x6d, 0x70,
  0x1e, 0x39,
  0x98, 0x1a
};
uint16_t LC306_Ready_Cnt=0;


int send_config_data_init = 0;
rt_device_t dev_lc306;
void send_config_data(uint8_t dataToSend)
{
    if (send_config_data_init==0) {
        send_config_data_init = 1;
        dev_lc306 = serial_device_find(SerialProtocol_Opt2);
        if(dev_lc306) set_serial_device_baud_rate(dev_lc306,19200);
    }

    if(dev_lc306)rt_device_write(dev_lc306, 0,&dataToSend,1);
}


int lc306_config_init(void)
{
    uint16_t len = sizeof(Sensor_cfg);
    send_config_data(0xAA);//0xAAָ
    send_config_data(0xAB);//0xAB
    send_config_data(tab_focus[0]);
    send_config_data(tab_focus[1]);
    send_config_data(tab_focus[2]);
    send_config_data(tab_focus[3]);
    send_config_data(tab_focus[0]^tab_focus[1]^tab_focus[2]^tab_focus[3]);

    rt_thread_mdelay(10);
    for(uint16_t i=0;i<len;i+=2)//0xBB
    {
        send_config_data(0xBB);
        send_config_data(SENSOR_IIC_ADDR);
        send_config_data(Sensor_cfg[i]);
        send_config_data(Sensor_cfg[i+1]);
        send_config_data(SENSOR_IIC_ADDR^Sensor_cfg[i]^Sensor_cfg[i+1]);
        rt_thread_mdelay(2);
    }

    send_config_data(0xDD);//0xDD

    return RT_EOK;
}
/* 导出到自动初始化 */
//INIT_APP_EXPORT(lc306_config_init);
#endif

